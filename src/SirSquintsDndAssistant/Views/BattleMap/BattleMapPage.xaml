<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:SirSquintsDndAssistant.ViewModels.BattleMap"
             xmlns:models="clr-namespace:SirSquintsDndAssistant.Models.BattleMap"
             xmlns:controls="clr-namespace:SirSquintsDndAssistant.Controls"
             xmlns:input="clr-namespace:SirSquintsDndAssistant.Input"
             x:Class="SirSquintsDndAssistant.Views.BattleMap.BattleMapPage"
             x:DataType="vm:BattleMapViewModel"
             Title="Battle Maps">

    <Grid ColumnDefinitions="280,*" Padding="5">
        <!-- Left Panel: Map List -->
        <Border Grid.Column="0" Style="{StaticResource Card}" Margin="0,0,5,0">
            <Grid RowDefinitions="Auto,Auto,*,Auto">
                <VerticalStackLayout Grid.Row="0">
                    <Label Text="Battle Maps" Style="{StaticResource SectionHeader}" Margin="0"/>
                    <Label Text="{Binding MapCountText}" FontSize="11" TextColor="{StaticResource Gray500}"/>
                </VerticalStackLayout>

                <Grid Grid.Row="1" ColumnDefinitions="*,*" ColumnSpacing="5" Margin="0,8">
                    <Button Text="+ New" Command="{Binding CreateMapCommand}"
                            Style="{StaticResource PrimaryButton}" HeightRequest="36" FontSize="12"/>
                    <Button Grid.Column="1" Text="Generate" Command="{Binding GenerateMapCommand}"
                            BackgroundColor="{StaticResource Success}" TextColor="{StaticResource White}" HeightRequest="36" FontSize="12"/>
                </Grid>

                <CollectionView Grid.Row="2" ItemsSource="{Binding Maps}"
                                SelectedItem="{Binding SelectedMap}"
                                SelectionMode="Single">
                    <CollectionView.EmptyView>
                        <Label Text="No battle maps yet. Create one!"
                               TextColor="{StaticResource Gray500}" HorizontalOptions="Center" Margin="20"/>
                    </CollectionView.EmptyView>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:BattleMap">
                            <SwipeView>
                                <SwipeView.RightItems>
                                    <SwipeItems>
                                        <SwipeItem Text="Copy"
                                                   BackgroundColor="{StaticResource Tertiary}"
                                                   Command="{Binding Source={RelativeSource AncestorType={x:Type vm:BattleMapViewModel}}, Path=DuplicateMapCommand}"
                                                   CommandParameter="{Binding .}"/>
                                        <SwipeItem Text="Delete"
                                                   BackgroundColor="{StaticResource Danger}"
                                                   Command="{Binding Source={RelativeSource AncestorType={x:Type vm:BattleMapViewModel}}, Path=DeleteMapCommand}"
                                                   CommandParameter="{Binding .}"/>
                                    </SwipeItems>
                                </SwipeView.RightItems>

                                <Border Style="{StaticResource Card}" Padding="8" Margin="0,2">
                                    <VerticalStackLayout>
                                        <Label Text="{Binding Name}" FontAttributes="Bold" FontSize="13"/>
                                        <Label FontSize="10" TextColor="{StaticResource Gray500}">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="{Binding GridWidth}"/>
                                                    <Span Text="x"/>
                                                    <Span Text="{Binding GridHeight}"/>
                                                    <Span Text=" grid"/>
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                    </VerticalStackLayout>
                                </Border>
                            </SwipeView>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Map Actions (when selected) -->
                <Border Grid.Row="3" Padding="8" Margin="0,5,0,0"
                        BackgroundColor="{AppThemeBinding Light={StaticResource ParchmentLight}, Dark={StaticResource SurfaceLight}}"
                        Stroke="{StaticResource Tertiary}" StrokeThickness="1"
                        IsVisible="{Binding IsMapSelected}">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="5"/>
                    </Border.StrokeShape>
                    <VerticalStackLayout Spacing="5">
                        <!-- Token section -->
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Text="Tokens" FontSize="12" FontAttributes="Bold"/>
                            <Label Grid.Column="1" Text="{Binding TokenCount, StringFormat='{0} total'}" FontSize="10" TextColor="{StaticResource Gray500}"/>
                        </Grid>
                        <Button Text="+ Add Token" Command="{Binding AddTokenCommand}"
                                BackgroundColor="{StaticResource Tertiary}" TextColor="{StaticResource White}" HeightRequest="32" FontSize="12"/>

                        <!-- Map actions -->
                        <BoxView HeightRequest="1" BackgroundColor="{StaticResource Gray400}" Margin="0,5"/>
                        <Label Text="Map Actions" FontSize="12" FontAttributes="Bold"/>
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="5">
                            <Button Text="Duplicate"
                                    Command="{Binding DuplicateMapCommand}"
                                    CommandParameter="{Binding SelectedMap}"
                                    BackgroundColor="{StaticResource Info}" TextColor="{StaticResource White}" HeightRequest="32" FontSize="11"/>
                            <Button Grid.Column="1" Text="Delete Map"
                                    Command="{Binding DeleteMapCommand}"
                                    CommandParameter="{Binding SelectedMap}"
                                    BackgroundColor="{StaticResource Danger}" TextColor="{StaticResource White}" HeightRequest="32" FontSize="11"/>
                        </Grid>
                    </VerticalStackLayout>
                </Border>
            </Grid>
        </Border>

        <!-- Right Panel: Map Canvas -->
        <Grid Grid.Column="1" RowDefinitions="Auto,*,Auto" IsVisible="{Binding IsMapSelected}">
            <!-- Toolbar -->
            <Border Grid.Row="0" Padding="8" Margin="0,0,0,5"
                    BackgroundColor="{AppThemeBinding Light={StaticResource ParchmentLight}, Dark={StaticResource SurfaceMedium}}"
                    Stroke="{StaticResource Success}" StrokeThickness="1">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="8"/>
                </Border.StrokeShape>

                <Grid ColumnDefinitions="*,Auto">
                    <!-- Tool Buttons -->
                    <HorizontalStackLayout Spacing="5">
                        <Button Text="Pan" Command="{Binding SetToolCommand}" CommandParameter="Pan"
                                BackgroundColor="{Binding CurrentTool, Converter={StaticResource ToolButtonColorConverter}, ConverterParameter=Pan}"
                                HeightRequest="32" WidthRequest="50" FontSize="11"/>
                        <Button Text="Select" Command="{Binding SetToolCommand}" CommandParameter="Select"
                                BackgroundColor="{Binding CurrentTool, Converter={StaticResource ToolButtonColorConverter}, ConverterParameter=Select}"
                                HeightRequest="32" WidthRequest="55" FontSize="11"/>
                        <Button Text="Move" Command="{Binding SetToolCommand}" CommandParameter="Move"
                                BackgroundColor="{Binding CurrentTool, Converter={StaticResource ToolButtonColorConverter}, ConverterParameter=Move}"
                                HeightRequest="32" WidthRequest="50" FontSize="11"/>
                        <BoxView WidthRequest="1" BackgroundColor="{StaticResource Gray400}" Margin="5,0"/>
                        <Button Text="Line" Command="{Binding SetToolCommand}" CommandParameter="MeasureLine"
                                BackgroundColor="{Binding CurrentTool, Converter={StaticResource ToolButtonColorConverter}, ConverterParameter=MeasureLine}"
                                HeightRequest="32" WidthRequest="45" FontSize="11"/>
                        <Button Text="Cone" Command="{Binding SetToolCommand}" CommandParameter="MeasureCone"
                                BackgroundColor="{Binding CurrentTool, Converter={StaticResource ToolButtonColorConverter}, ConverterParameter=MeasureCone}"
                                HeightRequest="32" WidthRequest="50" FontSize="11"/>
                        <Button Text="Circle" Command="{Binding SetToolCommand}" CommandParameter="MeasureCircle"
                                BackgroundColor="{Binding CurrentTool, Converter={StaticResource ToolButtonColorConverter}, ConverterParameter=MeasureCircle}"
                                HeightRequest="32" WidthRequest="50" FontSize="11"/>
                        <BoxView WidthRequest="1" BackgroundColor="{StaticResource Gray400}" Margin="5,0"/>
                        <Button Text="Reveal" Command="{Binding SetToolCommand}" CommandParameter="RevealFog"
                                BackgroundColor="{Binding CurrentTool, Converter={StaticResource ToolButtonColorConverter}, ConverterParameter=RevealFog}"
                                HeightRequest="32" WidthRequest="55" FontSize="11"/>
                        <Button Text="Hide" Command="{Binding SetToolCommand}" CommandParameter="HideFog"
                                BackgroundColor="{Binding CurrentTool, Converter={StaticResource ToolButtonColorConverter}, ConverterParameter=HideFog}"
                                HeightRequest="32" WidthRequest="45" FontSize="11"/>
                    </HorizontalStackLayout>

                    <!-- Right side controls -->
                    <HorizontalStackLayout Grid.Column="1" Spacing="5">
                        <Button Text="Grid" Command="{Binding ToggleGridCommand}"
                                BackgroundColor="{Binding ShowGrid, Converter={StaticResource BoolToToggleColorConverter}}"
                                HeightRequest="32" WidthRequest="45" FontSize="11"/>
                        <Button Text="Fog" Command="{Binding ToggleFogOfWarCommand}"
                                BackgroundColor="{Binding UseFogOfWar, Converter={StaticResource BoolToToggleColorConverter}}"
                                HeightRequest="32" WidthRequest="40" FontSize="11"/>
                        <Button Text="DM" Command="{Binding ToggleDmViewCommand}"
                                BackgroundColor="{Binding IsDmView, Converter={StaticResource BoolToToggleColorConverter}}"
                                HeightRequest="32" WidthRequest="35" FontSize="11"/>
                        <BoxView WidthRequest="1" BackgroundColor="{StaticResource Gray400}" Margin="5,0"/>
                        <Button Text="+" Command="{Binding ZoomInCommand}"
                                BackgroundColor="{StaticResource Gray500}" TextColor="{StaticResource White}" HeightRequest="32" WidthRequest="35" FontSize="14"/>
                        <Button Text="-" Command="{Binding ZoomOutCommand}"
                                BackgroundColor="{StaticResource Gray500}" TextColor="{StaticResource White}" HeightRequest="32" WidthRequest="35" FontSize="14"/>
                        <Button Text="Reset" Command="{Binding ResetViewportCommand}"
                                BackgroundColor="{StaticResource Gray500}" TextColor="{StaticResource White}" HeightRequest="32" WidthRequest="50" FontSize="11"/>
                    </HorizontalStackLayout>
                </Grid>
            </Border>

            <!-- Battle Map Canvas -->
            <Border Grid.Row="1" BackgroundColor="{StaticResource SurfaceDark}" Stroke="{StaticResource Gray600}" StrokeThickness="2">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="8"/>
                </Border.StrokeShape>

                <controls:BattleMapCanvas x:Name="MapCanvas"
                    Map="{Binding SelectedMap}"
                    Tokens="{Binding Tokens}"
                    SelectedToken="{Binding SelectedToken}"
                    CurrentTool="{Binding CurrentTool}"
                    ShowGrid="{Binding ShowGrid}"
                    UseFogOfWar="{Binding UseFogOfWar}"
                    IsDmView="{Binding IsDmView}"
                    ZoomLevel="{Binding ZoomLevel}"
                    CellTapped="OnCellTapped"
                    TokenSelected="OnTokenSelected"
                    TokenDragged="OnTokenDragged"
                    FogChanged="OnFogChanged"/>
            </Border>

            <!-- Status Bar -->
            <Border Grid.Row="2" Style="{StaticResource ActionBar}" Margin="0,5,0,0">
                <Grid ColumnDefinitions="*,Auto,Auto,Auto">
                    <Label Text="{Binding StatusText}" FontSize="11" VerticalOptions="Center"/>

                    <Label Grid.Column="1" VerticalOptions="Center" Margin="10,0" FontSize="11">
                        <Label.FormattedText>
                            <FormattedString>
                                <Span Text="Grid: "/>
                                <Span Text="{Binding GridWidth}"/>
                                <Span Text="x"/>
                                <Span Text="{Binding GridHeight}"/>
                            </FormattedString>
                        </Label.FormattedText>
                    </Label>

                    <Label Grid.Column="2" VerticalOptions="Center" Margin="10,0" FontSize="11">
                        <Label.FormattedText>
                            <FormattedString>
                                <Span Text="Zoom: "/>
                                <Span Text="{Binding ZoomLevel, StringFormat='{0:P0}'}"/>
                            </FormattedString>
                        </Label.FormattedText>
                    </Label>

                    <Label Grid.Column="3" VerticalOptions="Center" FontSize="11">
                        <Label.FormattedText>
                            <FormattedString>
                                <Span Text="Tokens: "/>
                                <Span Text="{Binding TokenCount}"/>
                            </FormattedString>
                        </Label.FormattedText>
                    </Label>
                </Grid>
            </Border>
        </Grid>

        <!-- No Map Selected Message -->
        <VerticalStackLayout Grid.Column="1" IsVisible="{Binding IsMapSelected, Converter={StaticResource InverseBoolConverter}}"
                             HorizontalOptions="Center" VerticalOptions="Center">
            <Label Text="Select a Battle Map" FontSize="24" TextColor="{StaticResource Primary}" HorizontalOptions="Center" FontAttributes="Bold"/>
            <Label Text="Choose a map from the left panel or create a new one" TextColor="{StaticResource Gray500}" FontSize="14" HorizontalOptions="Center"/>
        </VerticalStackLayout>

        <!-- Loading Indicator -->
        <ActivityIndicator Grid.ColumnSpan="2" IsRunning="{Binding IsLoading}" IsVisible="{Binding IsLoading}"
                           Color="{StaticResource Primary}"
                           HorizontalOptions="Center" VerticalOptions="Center"/>
    </Grid>
</ContentPage>
