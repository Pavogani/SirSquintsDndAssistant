<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:SirSquintsDndAssistant.ViewModels.Reference"
             xmlns:models="clr-namespace:SirSquintsDndAssistant.Models.Content"
             x:Class="SirSquintsDndAssistant.Views.Reference.ItemDatabasePage"
             x:DataType="vm:ItemDatabaseViewModel"
             Title="{Binding Title}">

    <Grid RowDefinitions="Auto, *" Padding="10">
        <!-- Search Bar -->
        <SearchBar Grid.Row="0"
                   Placeholder="Search items..."
                   Text="{Binding SearchText}"
                   Margin="0,0,0,10"/>

        <ScrollView Grid.Row="1">
            <VerticalStackLayout Spacing="15">

                <!-- Equipment Section -->
                <Label Text="Equipment" Style="{StaticResource SectionHeader}" Margin="0"/>

                <CollectionView ItemsSource="{Binding Equipment}" SelectionMode="None" HeightRequest="300">
                    <CollectionView.EmptyView>
                        <Label Text="No equipment found. Run data sync in Settings."
                               TextColor="{StaticResource Gray500}"
                               HorizontalOptions="Center"
                               Margin="0,20"/>
                    </CollectionView.EmptyView>

                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Equipment">
                            <Border Style="{StaticResource Card}" Padding="12" Margin="0,3">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ItemDatabaseViewModel}}, Path=ViewEquipmentCommand}"
                                        CommandParameter="{Binding .}"/>
                                </Border.GestureRecognizers>

                                <Grid ColumnDefinitions="*, Auto">
                                    <VerticalStackLayout Grid.Column="0">
                                        <Label Text="{Binding Name}"
                                               FontSize="15"
                                               FontAttributes="Bold"
                                               TextColor="{AppThemeBinding Light={StaticResource TextPrimary}, Dark={StaticResource White}}"/>
                                        <Label Text="{Binding EquipmentCategory}"
                                               FontSize="12"
                                               TextColor="{StaticResource Gray500}"/>
                                    </VerticalStackLayout>

                                    <!-- Cost -->
                                    <Label Grid.Column="1"
                                           VerticalOptions="Center"
                                           FontSize="12"
                                           TextColor="{StaticResource Secondary}">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="{Binding Cost}"/>
                                                <Span Text=" gp"/>
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Magic Items Section -->
                <Label Text="Magic Items" Style="{StaticResource SectionHeader}" Margin="0,10,0,0"/>

                <CollectionView ItemsSource="{Binding MagicItems}" SelectionMode="None" HeightRequest="300">
                    <CollectionView.EmptyView>
                        <Label Text="No magic items found. Run data sync in Settings."
                               TextColor="{StaticResource Gray500}"
                               HorizontalOptions="Center"
                               Margin="0,20"/>
                    </CollectionView.EmptyView>

                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:MagicItem">
                            <Border Padding="12" Margin="0,3"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource ParchmentLight}, Dark={StaticResource SurfaceCard}}"
                                    Stroke="{StaticResource Secondary}"
                                    StrokeThickness="1">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="8"/>
                                </Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ItemDatabaseViewModel}}, Path=ViewMagicItemCommand}"
                                        CommandParameter="{Binding .}"/>
                                </Border.GestureRecognizers>

                                <Grid ColumnDefinitions="*, Auto">
                                    <Label Grid.Column="0"
                                           Text="{Binding Name}"
                                           FontSize="15"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light={StaticResource TextPrimary}, Dark={StaticResource Parchment}}"/>

                                    <!-- Rarity Badge -->
                                    <Border Grid.Column="1"
                                            BackgroundColor="{StaticResource Primary}"
                                            Padding="8,4">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="4"/>
                                        </Border.StrokeShape>
                                        <Label Text="{Binding Rarity}"
                                               FontSize="11"
                                               TextColor="{StaticResource White}"
                                               FontAttributes="Bold"/>
                                    </Border>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

            </VerticalStackLayout>
        </ScrollView>

        <!-- Loading Indicator -->
        <ActivityIndicator Grid.Row="1"
                          IsRunning="{Binding IsBusy}"
                          IsVisible="{Binding IsBusy}"
                          Color="{StaticResource Primary}"
                          HorizontalOptions="Center"
                          VerticalOptions="Center"/>
    </Grid>
</ContentPage>
